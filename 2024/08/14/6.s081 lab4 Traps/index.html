<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="lab4 Traps" />
    <meta name="hexo-theme-A4" content="v1.9.2" />
    <link rel="alternate icon" type="image/webp" href="/img/logo.jpg">
    <title>Toki</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.2.0"></head>
    
    
        <style>
            .index-main{
                max-width:  880px;
            }
        </style>

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: '🌓', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/logo.jpg" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Toki</a> 
            <span class="description">Why so serious?</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
            
                <li><a href="/categories/">分类</a></li>
            
        
            
                <li><a href="/contact/">联系</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        
            
                <div class="post-main-title">
                    lab4 Traps
                </div>
            
        
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Traps"><span class="post-toc-text">Traps</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RISC-V-assembly"><span class="post-toc-text">RISC-V assembly</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1%EF%BC%9A%E5%8F%82%E6%95%B0%E5%AF%84%E5%AD%98%E5%99%A8"><span class="post-toc-text">1：参数寄存器</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2%EF%BC%9A%E5%86%85%E8%81%94"><span class="post-toc-text">2：内联</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3%EF%BC%9A%E8%B7%B3%E8%BD%AC"><span class="post-toc-text">3：跳转</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4%EF%BC%9ARA"><span class="post-toc-text">4：RA</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5%EF%BC%9A%E5%A4%A7%E7%AB%AF%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="post-toc-text">5：大端小端序</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#6%EF%BC%9A%E7%BC%BA%E5%A4%B1%E5%8F%82%E6%95%B0%E7%9A%84pritnf"><span class="post-toc-text">6：缺失参数的pritnf</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Backtrace"><span class="post-toc-text">Backtrace</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%80%E4%BA%9B%E5%B7%B2%E7%9F%A5%E7%9A%84%E6%83%85%E6%8A%A5"><span class="post-toc-text">一些已知的情报</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="post-toc-text">思路</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="post-toc-text">结果</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#alarm"><span class="post-toc-text">alarm</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%80%E4%BA%9B%E5%B7%B2%E7%9F%A5%E6%83%85%E6%8A%A5"><span class="post-toc-text">一些已知情报</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="post-toc-text">思路</span></a></li></ol></li></ol></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css"><div class=".article-gallery"><h2 id="Traps"><a href="#Traps" class="headerlink" title="Traps"></a>Traps</h2><p>本实验的主要代码位于：</p>
<blockquote>
<p>backtrace：<br>kernel&#x2F;printf.c<br>kernel&#x2F;riscv.h<br>alarm：kernel&#x2F;<br>    sysproc.c：sys_sigalarm &amp; sys_sigreturn<br>    proc.h：proc<br>    proc.c：allocproc<br>    trap.c：usertrap</p>
</blockquote>
<h3 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h3><a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814154820.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814154820.png" class title="Pasted image 20240814154820.png"></a>
<h4 id="1：参数寄存器"><a href="#1：参数寄存器" class="headerlink" title="1：参数寄存器"></a>1：参数寄存器</h4><p>a0-a7 作为参数寄存器；a2</p>
<h4 id="2：内联"><a href="#2：内联" class="headerlink" title="2：内联"></a>2：内联</h4><p>可以看到在 main 中并没有显示地调用 f ，而是直接把结果加载到了 a1：</p>
<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814155156.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814155156.png" class title="Pasted image 20240814155156.png"></a>

<p>在 f 中，函数 g 直接被内联：</p>
<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814160044.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814160044.png" class title="Pasted image 20240814160044.png"></a>

<h4 id="3：跳转"><a href="#3：跳转" class="headerlink" title="3：跳转"></a>3：跳转</h4><p>根据上文，调用 printf 时跳转到 ra 偏离 1586 的位置。如果使用gdb可以更好地体现这点</p>
<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814160253.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814160253.png" class title="Pasted image 20240814160253.png"></a>


<h4 id="4：RA"><a href="#4：RA" class="headerlink" title="4：RA"></a>4：RA</h4><p>跳转到 printf 后，ra应该等于 38</p>
<h4 id="5：大端小端序"><a href="#5：大端小端序" class="headerlink" title="5：大端小端序"></a>5：大端小端序</h4><a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814161336.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814161336.png" class title="Pasted image 20240814161336.png"></a>

<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814161316.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814161316.png" class title="Pasted image 20240814161316.png"></a>

<p>57616 的十六进制刚好是 E110，ASCII码中，r为0x72，l为0x6c，d为0x64</p>
<p>而xv6为小端序，也就是说从地址0<del>1，E110排布为：10 E1；0x00646c72从地址0</del>3，排布为：72 6c 64 00，所以打印出来为 rld\0</p>
<p>如果xv6为大端序，为了获得相同的输出，i需要更改为：72 6c 64 00。</p>
<p>而 57616 需要吗？gpt给的回答是需要，我觉得应该不用吧，作为一个数字类型怎么存的就怎么取，这些过程应该都是自动的，而不像字符串那么分散的形式</p>
<h4 id="6：缺失参数的pritnf"><a href="#6：缺失参数的pritnf" class="headerlink" title="6：缺失参数的pritnf"></a>6：缺失参数的pritnf</h4><p>一个随机值，动态参数中未初始化的变量</p>
<h3 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h3><h4 id="一些已知的情报"><a href="#一些已知的情报" class="headerlink" title="一些已知的情报"></a>一些已知的情报</h4><a href="/2024/08/14/6.s081%20lab4%20Traps/image%2018.avif" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/image%2018.avif" class title="image 18.avif"></a>

<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240812075712.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240812075712.png" class title="Pasted image 20240812075712.png"></a>


<p>获取 fp：</p>
<a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814170620.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814170620.png" class title="Pasted image 20240814170620.png"></a>

<p><code>请注意，xv6是小端序，而fp指向栈帧顶部，即ra位于fp-8，prev fp位于fp-16</code></p>
<blockquote>
<p>比如：栈帧1-8，则fp指向0</p>
</blockquote>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>首先调用 r_fp 获取当前fp的值x0，输出一行地址</p>
<p>获取x0-16处的值x1，输出一行地址</p>
<p>获取x1-16…..</p>
<p>直到栈顶，那么<code>如何判断栈顶</code>？xv6按页分配内存，在我们的例子中，stack只占一页，我们只需要判断fp指向的地址是否在同一页——通过使用宏：<code>PGROUNDDOWN</code>对页大小向下取整</p>
<p>顶部的fp可能也只是一个垃圾值，总之，和当前页号不一样就是到达了顶部</p>
<p>注意用%p，注意输出的是返回地址</p>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><a href="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814175214.png" class="gallery-item" style="box-shadow: none;"> <img src="/2024/08/14/6.s081%20lab4%20Traps/Pasted%20image%2020240814175214.png" class title="Pasted image 20240814175214.png"></a>

<p>于是我们可以愉快的把backtrace加入到panic中了</p>
<h3 id="alarm"><a href="#alarm" class="headerlink" title="alarm"></a>alarm</h3><p>据说完成只需要几行代码，但是难度是hard，让我试试</p>
<h4 id="一些已知情报"><a href="#一些已知情报" class="headerlink" title="一些已知情报"></a>一些已知情报</h4><p>CPU 每次时钟 tick 都会触发 timer interrupt</p>
<p><code>调用位于地址0处的函数</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*(<span class="type">void</span>(*)())fn)()</span><br></pre></td></tr></table></figure>

<p>内核和用户地址空间是不同的，虽然这在本实验中也没什么影响。特别注意，<code>不要在内核空间调用用户的函数</code></p>
<p>另外，执行 handler 时，会把用户原来的寄存器覆盖完，需要<code>保存原来的trapframe</code>，并确保在sigreturn时恢复了它们，以及 <code>a0</code></p>
<p>记得初始化 proc 中新的字段</p>
<p><code>防止重入</code>，执行 alarm_handler  时不能再次进入~</p>
<ul>
<li>alarm_handler 在最后会调用sigreturn。一般的操作系统会自动调用，不需要手动调用</li>
</ul>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>修改proc，添加字段记录总tick、当前tick、handler、timer_trapframe、timer_can_enter，在allocproc中初始化。修改 usertrap，当trap类型为定时器中断时，检查是否设置timer_handler，是则++tick。当tick等于总tick，重置tick，保存trapframe，设置timer_can_enter为0，设置返回指令为：handler中的第一句指令</p>
<p>在 sigreturn 中，需要恢复trapframe，enable timer handler，然后返回一个a0–这是一个系统调用</p>
</div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2024-08-14</span>
            
                <span>该篇文章被 Toki</span>
            
            
             
                <span>归为分类:
                    
                    
                        <a href='/categories/6-s081/'>
                            6.s081
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 2024 

            
                

            
                
                    / <a href="/contact/"> 联系 </a>
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>